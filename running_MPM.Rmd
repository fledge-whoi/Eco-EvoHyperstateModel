---
title: "Running the EvoDemo-Hyper Matrix Population Model in R"
author: "Timothée Bonnet"
date: "2024-10-28"
output: 
  html_document: 
    toc: yes
    toc_float: true
    toc_collapsed: true
    toc_depth: 3
    number_sections: true
    highlight: tango
    theme: cerulean
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This code is associated with the manuscript "Toward a unified approach to modeling adaptation among demographers and evolutionary ecologists" submitted to Methods in Ecology and Evolution (MEE) by Joanie Van de Walle, Jimmy Garnier, Timothée Bonnet and Stephanie Jenouvrier.

# Set-up

Packages that are needed to run the MPM function:

```{r}
library(pracma)
library(gsignal)
```


Packages to visualise results:

```{r}
library(tidyverse)
```




R-session and computer state when compiling this file:

```{r, eval=TRUE}
sessionInfo()
```


Load all MPM simulation functions:

```{r, eval=TRUE}
source("MPM_Functions.R")
```


# Define species

We define 5 species as a collection of vital rates and life-history properties.

```{r, eval=FALSE}
species_info <- data.frame(species=1:5,
                           fecundity = c(10.9868, 4.9958, 0.9987 ,0.3004 , 0.2286),
                           fertility = c(10.9868/0.0965, 4.9958/0.25, 0.9987/0.385 ,0.3004/0.505 , 0.2286/0.8),
                           adult_survival = c(0.0365, 0.2, 0.8, 0.93, 0.95), 
                           juvenile_survival = c(0.0965, 0.25, 0.385, 0.505, 0.8),
                           maturation_rate = c(0.9, 0.572, 0.4, 0.3, 0.07), 
                           generation_time = c(2.0476, 2.3697, 6.2983, 15.8066, 23.7847))

```

#

```{r}
output1 <- MPM(g = 20, Beta = 0.45, h2 = 0.6, xp = 8)

```


```{r}
pheno_distribution <- output1$pheno
colnames(pheno_distribution) <- 1:ncol(pheno_distribution)
pheno_distribution <- as_tibble(pheno_distribution) 
pheno_distribution$phenotypic_class <- 1:nrow(pheno_distribution)
pheno_distribution$phenotypic_midvalue <- output1$midpoint_e
pheno_distribution <- pheno_distribution %>% pivot_longer(cols = 1:(ncol(pheno_distribution)-2), names_to = "year", values_to = "density", names_transform = list(year = as.integer))
```

```{r}
pheno_distribution %>% ggplot(aes(x=year, y=density, colour=as.factor(phenotypic_class))) + geom_line()

pheno_distribution %>% filter(year %in% seq( from=1, to =101, by=20)) %>%
  ggplot(aes(x=phenotypic_class, y=density, fill=as.factor(phenotypic_class))) +
  geom_col() +
  facet_wrap(~year) + 
  theme_bw()


```

```{r}
output1$M_EBVSA
output1$M_EBVSJ
```

```{r}
(0.2286/0.8)*(1-0.2286/0.8)*0.45*0.6*100/output1$T_GEN

```



